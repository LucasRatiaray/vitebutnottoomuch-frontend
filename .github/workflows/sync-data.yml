# ðŸ”„ GitHub Action pour le frontend Vitebutnottoomuch
# Ã€ placer dans: frontend/.github/workflows/sync-data.yml

name: ðŸ”„ Sync Backend Data

on:
  # DÃ©clenchement manuel depuis GitHub
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Forcer la mise Ã  jour mÃªme si pas de nouvelle version'
        required: false
        default: 'false'
        type: boolean
  
  # DÃ©clenchement automatique via webhook depuis le backend
  repository_dispatch:
    types: [sync-data]
  
  # Backup automatique toutes les 12h
  schedule:
    - cron: '0 */12 * * *'

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ Checkout Frontend Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ“‹ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'
    
    - name: ðŸ“¦ Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
    
    - name: ðŸ” Check Current Version
      id: check-version
      run: |
        # CrÃ©er le dossier data s'il n'existe pas
        mkdir -p src/data
        
        # RÃ©cupÃ©rer la version locale actuelle
        LOCAL_VERSION="0"
        if [ -f "src/data/version.txt" ]; then
          LOCAL_VERSION=$(cat src/data/version.txt)
        fi
        
        echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT
        echo "ðŸ“ Version locale actuelle: $LOCAL_VERSION"
    
    - name: ðŸ“¥ Download Backend Data
      id: download
      run: |
        echo "ðŸ”„ Simulation du tÃ©lÃ©chargement des donnÃ©es backend..."
        
        # Pour l'instant, on simule car le backend est local
        # Dans un vrai setup, on ferait:
        # curl -s ${{ secrets.BACKEND_API_URL }}/exports/data.min.json > src/data/export.json
        # curl -s ${{ secrets.BACKEND_API_URL }}/exports/meta.json > src/data/meta.json
        # curl -s ${{ secrets.BACKEND_API_URL }}/exports/version.txt > src/data/version.txt
        
        # Simulation avec donnÃ©es de test
        cat > src/data/export.json << 'EOF'
        {
          "version": "$(date +%s)000",
          "generated": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)",
          "lastUpdate": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)",
          "stats": {
            "total": 8,
            "enriched": 8,
            "categories": ["DÃ©veloppement Web", "Frameworks JavaScript"],
            "technologies": {},
            "avgVitebutnottoomuchScore": 6.9
          },
          "pages": []
        }
        EOF
        
        # GÃ©nÃ©rer une nouvelle version pour test
        NEW_VERSION="$(date +%s)000"
        echo "$NEW_VERSION" > src/data/version.txt
        
        # CrÃ©er meta.json
        cat > src/data/meta.json << EOF
        {
          "version": "$NEW_VERSION",
          "generated": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)",
          "stats": {
            "total": 8,
            "enriched": 8,
            "categories": ["DÃ©veloppement Web", "Frameworks JavaScript"],
            "avgVitebutnottoomuchScore": 6.9
          }
        }
        EOF
        
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "ðŸ“¦ Nouvelles donnÃ©es tÃ©lÃ©chargÃ©es (version: $NEW_VERSION)"
    
    - name: âœ… Validate Data
      run: |
        echo "ðŸ” Validation des donnÃ©es tÃ©lÃ©chargÃ©es..."
        
        # VÃ©rifier que le JSON est valide
        if ! jq . src/data/export.json > /dev/null; then
          echo "âŒ JSON export invalide"
          exit 1
        fi
        
        if ! jq . src/data/meta.json > /dev/null; then
          echo "âŒ JSON meta invalide"
          exit 1
        fi
        
        # VÃ©rifier que la version existe
        if [ ! -f "src/data/version.txt" ]; then
          echo "âŒ Fichier version manquant"
          exit 1
        fi
        
        NEW_VERSION=$(cat src/data/version.txt)
        PAGES_COUNT=$(jq -r '.stats.total // 0' src/data/export.json)
        SCORE=$(jq -r '.stats.avgVitebutnottoomuchScore // 0' src/data/export.json)
        
        echo "âœ… DonnÃ©es valides:"
        echo "   â€¢ Version: $NEW_VERSION"
        echo "   â€¢ Pages: $PAGES_COUNT"
        echo "   â€¢ Score moyen: $SCORE/10"
    
    - name: ðŸ”„ Check if Update Needed
      id: should-update
      run: |
        LOCAL_VERSION="${{ steps.check-version.outputs.local_version }}"
        NEW_VERSION="${{ steps.download.outputs.new_version }}"
        FORCE_UPDATE="${{ github.event.inputs.force_update }}"
        
        if [ "$NEW_VERSION" != "$LOCAL_VERSION" ] || [ "$FORCE_UPDATE" = "true" ]; then
          echo "needs_update=true" >> $GITHUB_OUTPUT
          echo "ðŸ”„ Mise Ã  jour nÃ©cessaire (Local: $LOCAL_VERSION â†’ Nouveau: $NEW_VERSION)"
        else
          echo "needs_update=false" >> $GITHUB_OUTPUT
          echo "âœ… Aucune mise Ã  jour nÃ©cessaire (Version: $LOCAL_VERSION)"
        fi
    
    - name: ðŸ“ Commit Changes
      if: steps.should-update.outputs.needs_update == 'true'
      run: |
        # Configuration Git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Ajouter les fichiers
        git add src/data/
        
        # VÃ©rifier s'il y a des changements
        if git diff --staged --quiet; then
          echo "ðŸ“‹ Aucun changement dÃ©tectÃ©"
          exit 0
        fi
        
        # CrÃ©er le commit
        NEW_VERSION="${{ steps.download.outputs.new_version }}"
        PAGES_COUNT=$(jq -r '.stats.total // 0' src/data/export.json)
        SCORE=$(jq -r '.stats.avgVitebutnottoomuchScore // 0' src/data/export.json)
        
        git commit -m "ðŸ”„ Update backend data - v$NEW_VERSION

        ðŸ“Š Statistiques:
        â€¢ $PAGES_COUNT pages enrichies
        â€¢ Score moyen: $SCORE/10
        â€¢ GÃ©nÃ©rÃ©: $(date -u +%Y-%m-%d\ %H:%M:%S) UTC
        
        ðŸ¤– Auto-sync via GitHub Actions"
        
        echo "ðŸ“ Changements commitÃ©es"
    
    - name: ðŸš€ Push Changes
      if: steps.should-update.outputs.needs_update == 'true'
      run: |
        git push origin main
        echo "ðŸš€ Changements pushÃ©s vers main"
    
    - name: ðŸ”” Trigger Vercel Deploy
      if: steps.should-update.outputs.needs_update == 'true'
      run: |
        if [ -n "${{ secrets.VERCEL_DEPLOY_HOOK }}" ]; then
          echo "ðŸš€ DÃ©clenchement du dÃ©ploiement Vercel..."
          
          RESPONSE=$(curl -s -w "%{http_code}" -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}")
          HTTP_CODE="${RESPONSE: -3}"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "âœ… DÃ©ploiement Vercel dÃ©clenchÃ© avec succÃ¨s"
          else
            echo "âš ï¸ Ã‰chec du dÃ©ploiement Vercel (Code: $HTTP_CODE)"
          fi
        else
          echo "âš ï¸ VERCEL_DEPLOY_HOOK non configurÃ© dans les secrets"
        fi
    
    - name: ðŸ“Š Summary
      if: always()
      run: |
        echo "## ðŸ“‹ RÃ©sumÃ© de la synchronisation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.should-update.outputs.needs_update }}" = "true" ]; then
          NEW_VERSION="${{ steps.download.outputs.new_version }}"
          PAGES_COUNT=$(jq -r '.stats.total // 0' src/data/export.json 2>/dev/null || echo "N/A")
          SCORE=$(jq -r '.stats.avgVitebutnottoomuchScore // 0' src/data/export.json 2>/dev/null || echo "N/A")
          
          echo "### âœ… Mise Ã  jour effectuÃ©e" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $NEW_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Pages**: $PAGES_COUNT sites enrichis" >> $GITHUB_STEP_SUMMARY
          echo "- **Score moyen**: $SCORE/10" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: DÃ©ploiement en cours sur Vercel" >> $GITHUB_STEP_SUMMARY
        else
          echo "### â„¹ï¸ Aucune mise Ã  jour nÃ©cessaire" >> $GITHUB_STEP_SUMMARY
          echo "Les donnÃ©es sont dÃ©jÃ  Ã  jour." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **Liens utiles**:" >> $GITHUB_STEP_SUMMARY
        echo "- [Dashboard Vercel](https://vercel.com/dashboard)" >> $GITHUB_STEP_SUMMARY
        echo "- [Site frontend](https://vitebutnottoomuch.vercel.app)" >> $GITHUB_STEP_SUMMARY